from flask import Flask, request
import requests
import json
import torch
from ultralytics import YOLO
from PIL import Image
import io
from concurrent.futures import ThreadPoolExecutor

app = Flask(__name__)
executor = ThreadPoolExecutor(max_workers=3)

# Configuration
LINE_CHANNEL_ACCESS_TOKEN = 'bGkMvEDLmzYSBbUoAzY6T7xN7CaaB95jlW+96WiB88KD4ZMH20xOpTh2TQUzuGoMCQMFQ5ei4sVyaLRA7SkIaO/t2FUE6xk55bGb1FD6N9HCALAF9Dnqgsaz+7xkCGC27cKcB6YSsaclXYpc/FpSqwdB04t89/1O/w1cDnyilFU='
LEAF_MODEL_PATH = 'Leaf.pt'  # à¹‚à¸¡à¹€à¸”à¸¥à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹ƒà¸š
DISEASE_MODEL_PATH = 'DDR(ALL)0.1.pt'  # à¹‚à¸¡à¹€à¸”à¸¥à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„

# à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥
print("Loading YOLO models...")
try:
    # à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹ƒà¸š
    leaf_model = YOLO(LEAF_MODEL_PATH)
    leaf_model.fuse()
    leaf_model = leaf_model.cpu()
    
    # à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„
    disease_model = YOLO(DISEASE_MODEL_PATH)
    disease_model.fuse()
    disease_model = disease_model.cpu()
    
    print("Models loaded successfully")
except Exception as e:
    print(f"Error loading models: {e}")
    leaf_model = None
    disease_model = None

def send_line_message(reply_token, messages):
    """à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸›à¸¢à¸±à¸‡ LINE"""
    url = 'https://api.line.me/v2/bot/message/reply'
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'
    }
    
    if not isinstance(messages, list):
        messages = [messages]

    data = {
        'replyToken': reply_token,
        'messages': messages
    }

    try:
        response = requests.post(url, headers=headers, json=data, timeout=3)
        success = response.status_code == 200
        print(f"LINE API Response: {response.status_code}")
        if not success:
            print(f"Response content: {response.text}")
        return success
    except Exception as e:
        print(f"Error sending message: {e}")
        return False

def check_if_durian_leaf(image):
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚"""
    try:
        if leaf_model is None:
            print("Leaf detection model not loaded")
            return False, 0

        # à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ à¸²à¸žà¸”à¹‰à¸§à¸¢ YOLO classification
        results = leaf_model(image)[0]
        
        # à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸¥à¹‡à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£ debug
        print(f"Raw results: {results}")
        
        if not hasattr(results, 'probs') or results.probs is None:
            print("No probability data found")
            return False, 0
            
        # à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸‚à¸­à¸‡à¸—à¸¸à¸à¸„à¸¥à¸²à¸ª
        probs_data = results.probs.data.cpu().numpy()
        for idx, prob in enumerate(probs_data):
            class_name = results.names[idx]
            print(f"Class: {class_name}, Probability: {prob:.3f}")
        
        # à¸”à¸¶à¸‡à¸„à¹ˆà¸² confidence à¹à¸¥à¸° class à¸ªà¸¹à¸‡à¸ªà¸¸à¸”
        class_idx = int(results.probs.argmax())
        confidence = float(results.probs.max())
        class_name = results.names[class_idx]
        
        print(f"Best match - Class: {class_name}, Confidence: {confidence:.3f}")
        
        # à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
        is_durian = False
        final_confidence = 0
        
        if class_name == 'durian_leaf':
            # à¸›à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”à¸‚à¸­à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š
            confidence_threshold = 0.25  # à¸¥à¸”à¸ˆà¸²à¸ 0.3
            
            # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸±à¹ˆà¸™
            if confidence >= confidence_threshold:
                is_durian = True
                final_confidence = confidence
                print(f"Durian leaf detected with confidence: {confidence:.3f}")
            else:
                print(f"Confidence too low: {confidence:.3f} < {confidence_threshold}")
                
            # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸‚à¸­à¸‡à¸„à¸¥à¸²à¸ªà¸­à¸·à¹ˆà¸™
            second_best_idx = probs_data.argsort()[-2]
            second_best_prob = probs_data[second_best_idx]
            margin = confidence - second_best_prob
            
            print(f"Margin from second best class: {margin:.3f}")
            
            # à¸–à¹‰à¸²à¸„à¸§à¸²à¸¡à¸•à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢à¹€à¸à¸´à¸™à¹„à¸› à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆ
            if margin < 0.1:
                print("Small margin between classes, reducing confidence")
                final_confidence *= 0.8  # à¸¥à¸”à¸„à¸§à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸±à¹ˆà¸™à¸¥à¸‡
        else:
            print(f"Not a durian leaf: {class_name}")
            
        return is_durian, final_confidence
            
    except Exception as e:
        print(f"Error in leaf detection: {e}")
        import traceback
        print(f"Full traceback: {traceback.format_exc()}")
        return False, 0

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸œà¸¥à¸à¸²à¸£à¸—à¸³à¸™à¸²à¸¢à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
def print_all_probabilities(results):
    """à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸‚à¸­à¸‡à¸—à¸¸à¸à¸„à¸¥à¸²à¸ª"""
    if hasattr(results, 'probs') and results.probs is not None:
        probs = results.probs.data.cpu().numpy()
        for idx, prob in enumerate(probs):
            class_name = results.names[idx]
            print(f"Class: {class_name}, Probability: {prob:.3f}")

def analyze_image(image_content):
    """à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¸¹à¸›à¸ à¸²à¸žà¸ˆà¸²à¸ binary content"""
    try:
        if disease_model is None:
            print("Disease model not loaded")
            return None, 0

        # à¹à¸›à¸¥à¸‡ bytes à¹€à¸›à¹‡à¸™ PIL Image
        image = Image.open(io.BytesIO(image_content))
        
        # à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹‚à¸£à¸„à¸”à¹‰à¸§à¸¢ YOLOv11
        results = disease_model(image)
        print(f"Raw results: {results}")  # debug info
        
        if not results:
            print("No results from model")
            return None, 0
            
        result = results[0]  # get first result
        print(f"Result object: {result}")  # debug info
        
        try:
            # à¸”à¸¶à¸‡à¸œà¸¥à¸à¸²à¸£à¸—à¸³à¸™à¸²à¸¢à¹à¸šà¸š YOLOv11 classification
            probabilities = result.probs.data.cpu().numpy()  # à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ numpy array
            class_idx = probabilities.argmax()
            confidence = float(probabilities[class_idx])
            class_name = result.names[class_idx]
            
            print(f"Debug - Class: {class_name}, Confidence: {confidence}")
            print(f"All probabilities: {probabilities}")
            
            # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¹ˆà¸² confidence
            if confidence < 0.2:
                print(f"Low confidence: {confidence}")
                return None, 0
                
            # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸·à¹ˆà¸­à¸„à¸¥à¸²à¸ª
            valid_classes = ['Anthracnose', 'Normal', 'Powdery', 'Rust']
            if class_name not in valid_classes:
                print(f"Invalid class: {class_name}")
                return None, 0
                
            return class_name, confidence
            
        except Exception as e:
            print(f"Error extracting prediction: {e}")
            print(f"Result structure: {dir(result)}")  # à¹à¸ªà¸”à¸‡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸­à¸‡ result
            return None, 0

    except Exception as e:
        print(f"Error in analyze_image: {e}")
        import traceback
        print(f"Full traceback: {traceback.format_exc()}")
        return None, 0

def create_response_messages(class_name, confidence):
    """à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ"""
    # à¸à¸£à¸“à¸µà¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸œà¸¥à¹„à¸”à¹‰
    if not class_name or confidence < 0.5:  
        return [{
            'type': 'text',
            'text': "âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸œà¸¥à¹„à¸”à¹‰\n\n"
                   "ðŸ”¸ à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰:\n"
                   "- à¸ à¸²à¸žà¹„à¸¡à¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™\n"
                   "- à¹à¸ªà¸‡à¸ªà¸§à¹ˆà¸²à¸‡à¹„à¸¡à¹ˆà¹€à¸žà¸µà¸¢à¸‡à¸žà¸­\n"
                   "- à¸¡à¸¸à¸¡à¸–à¹ˆà¸²à¸¢à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡\n"
                   "- à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸ à¸²à¸žà¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™\n\n"
                   "ðŸ”¸ à¸„à¸³à¹à¸™à¸°à¸™à¸³:\n"
                   "1. à¸–à¹ˆà¸²à¸¢à¹ƒà¸™à¸—à¸µà¹ˆà¸¡à¸µà¹à¸ªà¸‡à¸ªà¸§à¹ˆà¸²à¸‡à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­\n"
                   "2. à¸–à¹ˆà¸²à¸¢à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¹ƒà¸šà¸Šà¸±à¸”à¹€à¸ˆà¸™\n"
                   "3. à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¹€à¸‡à¸²à¸—à¸µà¹ˆà¸šà¸±à¸‡à¹ƒà¸š\n"
                   "4. à¸–à¹ˆà¸²à¸¢à¹ƒà¸™à¸£à¸°à¸¢à¸°à¹ƒà¸à¸¥à¹‰à¸žà¸­à¸ªà¸¡à¸„à¸§à¸£"
        }]

    # à¸à¸£à¸“à¸µà¹‚à¸£à¸„à¹à¸­à¸™à¹à¸—à¸£à¸„à¹‚à¸™à¸ª
    if class_name == 'Anthracnose':
        return [{
            'type': 'text',
            'text': f"ðŸ” à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ {confidence:.1%}):\n"
                   f"âš ï¸ à¸žà¸šà¹‚à¸£à¸„à¹à¸­à¸™à¹à¸—à¸£à¸„à¹‚à¸™à¸ª (Anthracnose Disease)\n\n"
                   f"ðŸ”¸ à¸¥à¸±à¸à¸©à¸“à¸°à¸­à¸²à¸à¸²à¸£:\n"
                   f"- à¹à¸œà¸¥à¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¸–à¸¶à¸‡à¸”à¸³\n"
                   f"- à¹à¸œà¸¥à¸¡à¸µà¸‚à¸­à¸šà¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡\n"
                   f"- à¹ƒà¸šà¸­à¸²à¸ˆà¹€à¸«à¸µà¹ˆà¸¢à¸§à¹à¸¥à¸°à¸£à¹ˆà¸§à¸‡\n\n"
                   f"ðŸ”¸ à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£:\n"
                   f"1. à¸•à¸±à¸”à¹à¸•à¹ˆà¸‡à¸à¸´à¹ˆà¸‡à¹à¸¥à¸°à¹ƒà¸šà¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸—à¸´à¹‰à¸‡\n"
                   f"2. à¸‰à¸µà¸”à¸žà¹ˆà¸™à¸ªà¸²à¸£à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸³à¸ˆà¸±à¸”à¹€à¸Šà¸·à¹‰à¸­à¸£à¸²\n"
                   f"3. à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸²à¸£à¸£à¸°à¸šà¸²à¸¢à¸­à¸²à¸à¸²à¸¨\n"
                   f"4. à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¸™à¹‰à¸³à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸”à¸¢à¸•à¸£à¸‡"
        }]

    # à¸à¸£à¸“à¸µà¹ƒà¸šà¸›à¸à¸•à¸´
    elif class_name == 'Normal':
        return [{
            'type': 'text',
            'text': f"ðŸ” à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ {confidence:.1%}):\n"
                   f"âœ… à¹ƒà¸šà¸›à¸à¸•à¸´ à¹„à¸¡à¹ˆà¸žà¸šà¹‚à¸£à¸„\n\n"
                   f"ðŸ”¸ à¸¥à¸±à¸à¸©à¸“à¸°à¹ƒà¸š:\n"
                   f"- à¹ƒà¸šà¸¡à¸µà¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸›à¸à¸•à¸´\n"
                   f"- à¹„à¸¡à¹ˆà¸žà¸šà¸£à¹ˆà¸­à¸‡à¸£à¸­à¸¢à¸‚à¸­à¸‡à¹‚à¸£à¸„\n\n"
                   f"ðŸ”¸ à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸”à¸¹à¹à¸¥:\n"
                   f"1. à¸”à¸¹à¹à¸¥à¸£à¸±à¸à¸©à¸²à¸•à¸²à¸¡à¸›à¸à¸•à¸´\n"
                   f"2. à¸£à¸”à¸™à¹‰à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­\n"
                   f"3. à¹ƒà¸«à¹‰à¸›à¸¸à¹‹à¸¢à¸•à¸²à¸¡à¸à¸³à¸«à¸™à¸”\n"
                   f"4. à¸«à¸¡à¸±à¹ˆà¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸²à¸à¸²à¸£à¸œà¸´à¸”à¸›à¸à¸•à¸´"
        }]

    # à¸à¸£à¸“à¸µà¹‚à¸£à¸„à¸£à¸²à¹à¸›à¹‰à¸‡
    elif class_name == 'Powdery':
        return [{
            'type': 'text',
            'text': f"ðŸ” à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ {confidence:.1%}):\n"
                   f"âš ï¸ à¸žà¸šà¹‚à¸£à¸„à¸£à¸²à¹à¸›à¹‰à¸‡ (Powdery Mildew)\n\n"
                   f"ðŸ”¸ à¸¥à¸±à¸à¸©à¸“à¸°à¸­à¸²à¸à¸²à¸£:\n"
                   f"- à¸žà¸šà¸œà¸‡à¸ªà¸µà¸‚à¸²à¸§à¸„à¸¥à¹‰à¸²à¸¢à¹à¸›à¹‰à¸‡à¸šà¸™à¹ƒà¸š\n"
                   f"- à¹ƒà¸šà¸­à¸²à¸ˆà¸šà¸´à¸”à¹€à¸šà¸µà¹‰à¸¢à¸§à¸«à¸£à¸·à¸­à¹€à¸«à¸µà¹ˆà¸¢à¸§\n"
                   f"- à¸­à¸²à¸ˆà¸žà¸šà¸ˆà¸¸à¸”à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡à¸šà¸™à¹ƒà¸š\n\n"
                   f"ðŸ”¸ à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£:\n"
                   f"1. à¸‰à¸µà¸”à¸žà¹ˆà¸™à¸ªà¸²à¸£à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸³à¸ˆà¸±à¸”à¹€à¸Šà¸·à¹‰à¸­à¸£à¸²\n"
                   f"2. à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸£à¸°à¸šà¸²à¸¢à¸­à¸²à¸à¸²à¸¨\n"
                   f"3. à¸¥à¸”à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¹ƒà¸™à¸ªà¸§à¸™\n"
                   f"4. à¸à¸³à¸ˆà¸±à¸”à¸§à¸±à¸Šà¸žà¸·à¸Šà¸£à¸­à¸šà¸•à¹‰à¸™"
        }]

    # à¸à¸£à¸“à¸µà¹‚à¸£à¸„à¸£à¸²à¸ªà¸™à¸´à¸¡
    elif class_name == 'Rust':
        return [{
            'type': 'text',
            'text': f"ðŸ” à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ {confidence:.1%}):\n"
                   f"âš ï¸ à¸žà¸šà¹‚à¸£à¸„à¸£à¸²à¸ªà¸™à¸´à¸¡ (Rust Disease)\n\n"
                   f"ðŸ”¸ à¸¥à¸±à¸à¸©à¸“à¸°à¸­à¸²à¸à¸²à¸£:\n"
                   f"- à¸žà¸šà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¹à¸”à¸‡à¸šà¸™à¹ƒà¸š\n"
                   f"- à¸­à¸²à¸ˆà¸žà¸šà¸œà¸‡à¸ªà¸›à¸­à¸£à¹Œà¸ªà¸µà¸ªà¹‰à¸¡à¹ƒà¸•à¹‰à¹ƒà¸š\n\n"
                   f"ðŸ”¸ à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£:\n"
                   f"1. à¹à¸¢à¸à¹ƒà¸šà¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸­à¸­à¸à¹à¸¥à¸°à¹€à¸œà¸²à¸—à¸³à¸¥à¸²à¸¢\n"
                   f"2. à¸‰à¸µà¸”à¸žà¹ˆà¸™à¸ªà¸²à¸£à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸³à¸ˆà¸±à¸”à¹€à¸Šà¸·à¹‰à¸­à¸£à¸²\n"
                   f"3. à¸„à¸§à¸šà¸„à¸¸à¸¡à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¹ƒà¸™à¸ªà¸§à¸™\n"
                   f"4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸‚à¹‰à¸²à¸‡à¹€à¸„à¸µà¸¢à¸‡"
        }]
    
    # à¸à¸£à¸“à¸µà¸­à¸·à¹ˆà¸™à¹†
    return [{
        'type': 'text',
        'text': "âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸œà¸¥à¹„à¸”à¹‰\n\n"
               "à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸ à¸²à¸žà¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸ à¸²à¸žà¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™\n"
               "à¹à¸¥à¸°à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸žà¹ƒà¸™à¸ªà¸ à¸²à¸žà¹à¸ªà¸‡à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡"
    }]

def process_image_message(image_id, reply_token):
    """à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸£à¸¹à¸›à¸ à¸²à¸žà¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ"""
    try:
        # à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸ž
        url = f'https://api-data.line.me/v2/bot/message/{image_id}/content'
        headers = {'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'}
        
        response = requests.get(url, headers=headers, timeout=3)
        if response.status_code != 200:
            send_line_message(reply_token, [{
                'type': 'text',
                'text': 'âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸žà¹„à¸”à¹‰\nà¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡'
            }])
            return

        # à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¸¹à¸›à¸ à¸²à¸žà¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
        class_name, confidence = analyze_image(response.content)
        messages = create_response_messages(class_name, confidence)
        send_line_message(reply_token, messages)

    except Exception as e:
        print(f"Error in process_image_message: {e}")
        send_line_message(reply_token, [{
            'type': 'text',
            'text': 'âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ\nà¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡'
        }])
        
@app.route("/webhook", methods=['POST'])
def webhook():
    """à¸ˆà¸±à¸”à¸à¸²à¸£ webhook request"""
    try:
        data = request.get_json()
        if not data or 'events' not in data:
            return 'OK', 200

        for event in data['events']:
            if event.get('type') != 'message':
                continue

            message = event.get('message', {})
            reply_token = event.get('replyToken')

            if not reply_token:
                continue

            if message.get('type') == 'image':
                process_image_message(message.get('id'), reply_token)
            elif message.get('type') == 'text':
                text = message.get('text', '').strip().lower()
                if text in ['help', 'à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­']:
                    send_line_message(reply_token, [{
                        'type': 'text',
                        'text': "ðŸ“± à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¹‚à¸£à¸„à¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™:\n\n"
                               "1. à¸à¸²à¸£à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸ž:\n"
                               "- à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸žà¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™à¹ƒà¸™à¸£à¸°à¸¢à¸°à¹ƒà¸à¸¥à¹‰\n"
                               "- à¹ƒà¸«à¹‰à¹à¸ªà¸‡à¸ªà¸§à¹ˆà¸²à¸‡à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­\n"
                               "- à¸–à¹ˆà¸²à¸¢à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¹ƒà¸šà¸Šà¸±à¸”à¹€à¸ˆà¸™\n\n"
                               "2. à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸ à¸²à¸ž:\n"
                               "- à¸ªà¹ˆà¸‡à¸—à¸µà¸¥à¸° 1 à¸ à¸²à¸ž\n"
                               "- à¸£à¸­à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ\n\n"
                               "3. à¸à¸²à¸£à¸­à¹ˆà¸²à¸™à¸œà¸¥:\n"
                               "- à¸£à¸°à¸šà¸šà¸ˆà¸°à¹à¸ˆà¹‰à¸‡à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ\n"
                               "- à¸žà¸£à¹‰à¸­à¸¡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£"
                    }])
                else:
                    send_line_message(reply_token, [{
                        'type': 'text',
                        'text': "ðŸ‘‹ à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š\n\n"
                               "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¹‚à¸£à¸„à¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™\n"
                               "à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸žà¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š\n"
                               "à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œ 'help' à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™"
                    }])

        return 'OK', 200

    except Exception as e:
        print(f"Error in webhook: {e}")
        return 'OK', 200

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)
